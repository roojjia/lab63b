# การทดลองที่ 7 เรื่อง การเขียนโปรแกรมเพื่อรันบนไมโครคอนโทรเลอร์

## วัตถุประสงค์
  - เพื่อให้เข้าใจการเขียนโปรแกรมและอัปโหลดลงใน microcontroller
  - เพื่อให้เข้าใจการต่ออปุกรณ์ต่างๆกับ microcontroller
  - เพื่อนำ microcontroller ไปประยุกต์ใช้ให้เกิดประโยชน์ในชีวิตประจำวัน
   
## อุปกรณ์ที่ใช้
  1. mitrocontroller (ESP-01)
  2. USB to Serial
  3. เสาไฟจราจร 2 เสา
  4. สายไฟต่อวงจร
  
## แหล่งข้อมูล
  1. ตัวอย่าง src code ของโปรแกรมในการทดลองที่ 1 - 6 : https://github.com/choompol-boonmee/lab63b/tree/master/examples
  2. โปรแกรมการทดลองที่ 7 : https://github.com/roojjia/lab63b/blob/main/src_code/ex7_lab7/main.cpp
  
## วิธีการทดลอง
  1. กำหนดให้ไฟจราจรสีแดงและสีเขียวแต่ละครั้ังใช้เวลา 30 วินาที และไฟจราจรสีเหลืองใช้เวลา 5 วินาที
  2. ต่อ microcontroller เข้ากับ USB to serial และต่อสายไฟเข้ากับเสาไฟจราจร ดังภาพ
  
  ![image](https://user-images.githubusercontent.com/80879780/113132523-c24c1a00-9248-11eb-8af4-e50b9c1bc58a.png)
  
  3. เปิด command prompt
  4. เปิดโปรแกรมที่ใช้ในการทดสอบ โดยใช้คำสั่ง **cd ex7_lab7** 
  5. พิมพ์คำสั่ง **vi src/main.cpp** 
  6. เมื่อกด Enter จะได้ข้อมูลดังนี้
 
  ```javascript
  #include <Arduino.h>
  // กำหนดไฟเลน 1
int R1 = 1; // ขา Digital 1 เป็น  ไฟแดงเลน 1
int Y1 = 2; // ขา Digital 2 เป็น  ไฟเหลืองเลน 1
int G1 = 3; // ขา Digital 3 เป็น  ไฟเขียวเลน 1

// กำหนดไฟเลน 2
int R2 = 4; // ขา Digital 4 เป็น  ไฟแดงเลน 2
int Y2 = 5; // ขา Digital 5 เป็น  ไฟเหลืองเลน 2
int G2 = 6; // ขา Digital 6 เป็น  ไฟเขียวเลน 2

void setup(){
    pinMode(R1, OUTPUT);
    pinMode(Y1, OUTPUT);
    pinMode(G1, OUTPUT);
    pinMode(R2, OUTPUT);
    pinMode(Y2, OUTPUT);
    pinMode(G2, OUTPUT);
}

void loop(){
    // ให้สัญญาณไฟเหลือง เลน 1 ก่อน
    digitalWrite(Y1, HIGH); // ให้สัญญาณไฟเหลือง เลน 1
    digitalWrite(G1, LOW);
    delay(2500); //2.5วินาที

    // ปิดไฟเหลืองสองฝั่ง, จากนั้นให้สัญญาณไฟแดงเลน 1, กับให้สัญญาณไฟเขียวเลน 2 พร้อมกัน
    digitalWrite(R1, HIGH); //ให้สัญญาณไฟแดง เลน 1
    digitalWrite(G2, HIGH); //ให้สัญญาณไฟเขียว เลน 2
    digitalWrite(Y1, LOW);
    digitalWrite(Y2, LOW);
    digitalWrite(R2, LOW);
    delay(15000); //15วินาที

    // ให้สัญญาณไฟเหลือง เลน 2
    digitalWrite(Y2, HIGH); // ให้สัญญาณไฟเหลือง เลน 2
    digitalWrite(G2, LOW);
    delay(2500); //2.5วินาที

    // ปิดไฟเหลืองสองฝั่ง, จากนั้นให้สัญญาณไฟแดงเลน 2,กับให้สัญญาณไฟเขียวเลน 1 พร้อมกัน
    digitalWrite(R2, HIGH); //ให้สัญญาณไฟแดง เลน 2
    digitalWrite(G1, HIGH); //ให้สัญญาณไฟเขียว เลน 1
    digitalWrite(Y1, LOW);
    digitalWrite(R1, LOW);
    digitalWrite(Y2, LOW);
    delay(15000); //15วินาที
}
   }
  ```  
  
  7. upload โปรแกรมไปยัง microcontroller โดยใช้คำสั่ง **pio run -t upload** 
  
  9. กดปุ่มสีดำบน microcontrolller เพื่อทำการ upload ข้อมูล
  10. กดปุ่มสีแดงบน microcontroller เพื่อทำการ reset
  11. เมื่อโปรแกรม upload ข้อมูลเสร็จ ให้ใช้คำสั่ง **pio device monitor**
  12. โปรแกรมทำการแสดงผล
 
## บันทึกผลการทดลอง
   จากการเขียนโปรแกรม พบว่า เสาไฟจราจรทั้ง 2 เสา จะแสดงไฟสีแดง สลับกับสีเขียว 30 วินาที โดยที่มีไฟสีเหลืองคั่นกลาง เป็นเวลา 5 วินาที และสามารถบันทึกผลได้ดังนี้
   
   ![image](https://user-images.githubusercontent.com/80879780/113141261-adc14f00-9253-11eb-91ae-05a4c2091bfe.png)

   
## อภิปรายผลการทดลอง
  จากการเขียนโปรแกรมไฟจราจร 2 เลนโดยใช้ microcontroller พบว่า เมื่อทำการอัปโหลดข้อมูลลงไปใน microcontroller จะทำให้เสาไฟจราจรทั้ง 2 ทำงานโดยจะแสดงไฟสีแดงและเขียวเป็นเวลา 30 วินาที ตามที่กำหนด และแสดงผลต่อด้วยไฟสีเหลืองเป็นเวลา 5 วินาที ทำการแสดงผลไปเรื่อยๆเป็นลูป และสามารถนำไปประยุกต์ใช้ได้โดยการทำเป็นไฟจราจร 3,4,5 เลน เพื่อนำไปใช้ในชีวิตประจำวัน
   
## คำถามท้ายการทดลอง
  การต่อไฟจราจรจะสามารถกำหนดเวลาโดยที่ทำให้รถไม่ติดได้หรือไม่
  
 __ตอบ__  ได้ โดยใช้ตัวเซนเซอร์ในการระบุปริมาณรถในแต่ละเลน และทำการประมวลผลคาดคะเนระยะเวลาที่จะปล่อยให้รถในแต่ละแถวเคลื่อนที่ 
